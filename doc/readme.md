# 工业缺陷分割系统功能拆分与实现指南（PyQt + SAM + 模型训练 + 预测）

## 一、系统概览

**目标**：构建一套完整的工业缺陷分割系统，实现 **标注 → 模型训练 → 预测 → 可视化** 全流程。  

**核心模块**：
1. 数据管理  
2. 自动标注（SAM）  
3. 人工修正  
4. 标注数据保存与管理  
5. 模型训练  
6. 预测与推理  
7. 可视化与报告  

---

## 二、功能模块拆分

### 1. 数据管理模块
- **功能**：
  - 图片/视频导入（文件夹、单图、视频）  
  - 浏览与缩放（QGraphicsView + QGraphicsScene）  
  - 批量管理和任务顺序控制  
  - 数据统一存储结构：
    ```
    dataset/
      ├─ images/
      ├─ masks/
      └─ annotations/
    ```
- **实现步骤**：
  1. 使用 `QFileDialog` 选择文件夹或单张图片  
  2. QGraphicsView 加载图片并支持缩放、滚动  
  3. 批量文件列表维护（QListWidget 或 TableView）  

---

### 2. 自动标注模块（SAM）
- **功能**：
  - 调用 SAM 模型生成 mask  
  - 支持点、负点、bbox 提示  
  - 支持多实例目标  
  - 异步处理避免 GUI 卡顿  
  - mask 可叠加显示在原图上  
- **实现步骤**：
  1. GUI 提供自动标注按钮  
  2. 通过 PyTorch 加载 SAM 模型  
  3. 采集用户提供的提示（点/框）  
  4. 异步调用 SAM 推理  
  5. 将 mask 转 QPixmap 并覆盖显示  

---

### 3. 人工修正模块
- **功能**：
  - 涂抹/橡皮工具  
  - 多边形绘制（polygon）  
  - 撤销/重做操作  
  - 局部放大进行精细标注  
- **实现步骤**：
  1. 使用 `QMouseEvent` 捕获鼠标操作  
  2. QPainter 绘制 mask 叠加层  
  3. 操作历史管理（QStack）实现撤销/重做  
  4. 支持 polygon 绘制完成闭合  

---

### 4. 标注数据管理
- **功能**：
  - mask 保存（PNG / numpy array）  
  - bbox/polygon 保存（YOLO / COCO JSON）  
  - 批量导出训练格式  
- **实现步骤**：
  1. mask numpy → PNG 保存  
  2. polygon / bbox → JSON / YOLO txt  
  3. 支持批量导出整个任务  

---

### 5. 模型训练模块
- **功能**：
  - 支持模型：U-Net / YOLOv11-Seg / DeepLabV3+  
  - 训练参数配置（学习率、batch、epoch）  
  - 异步训练管理和日志显示  
  - 数据增强：旋转、翻转、亮度、噪声等  
- **实现步骤**：
  1. GUI 配置训练参数  
  2. QThread 调用训练脚本  
  3. 前端 QTextEdit 显示训练日志  
  4. 保存训练好的模型权重  

---

### 6. 预测与推理模块
- **功能**：
  - 单图/批量预测  
  - mask / bbox 显示  
  - 后处理：腐蚀/膨胀/去噪  
  - 支持人工微调预测结果  
- **实现步骤**：
  1. GUI 选择测试图片或视频  
  2. 异步调用训练好的模型进行预测  
  3. mask 转 QPixmap 显示  
  4. 提供微调功能（涂抹/修正）  

---

### 7. 可视化与报告模块
- **功能**：
  - mask / bbox 可视化  
  - 缺陷统计：数量、面积、分布  
  - 报告导出：Excel / PDF  
  - 图表嵌入 GUI（Matplotlib / PyQtGraph）  
- **实现步骤**：
  1. 统计 mask / bbox 信息  
  2. 使用 Matplotlib / PyQtGraph 绘制图表  
  3. 导出 Excel 或 PDF  

---

## 三、功能实现顺序建议（Step by Step）

1. **数据管理基础**：加载图片/视频、显示和浏览  
2. **人工标注基础**：画笔/橡皮/多边形 + 保存 mask  
3. **集成 SAM**：自动生成 mask + GUI 显示  
4. **标注管理**：批量保存、YOLO/COCO 导出  
5. **模型训练模块**：训练参数配置 + 异步训练  
6. **预测推理模块**：单图/批量预测 + mask 显示  
7. **可视化与报告**：统计缺陷、生成报告  
8. **迭代闭环**：新标注数据 → 模型微调 → 更新预测  

---

## 四、系统特点
- 半自动标注闭环：SAM 自动生成 → 人工微调 → 保存  
- 小缺陷优化：局部放大 + 精细标注  
- 批量任务处理：图片 / 视频顺序标注  
- 多模型支持：U-Net / YOLOv11-Seg / DeepLabV3+  
- 可扩展训练与推理：异步管理、日志显示  
- 完整导出：mask、bbox、polygon、训练数据、统计报告  
